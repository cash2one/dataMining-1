<?php

function checkUserLogin($userUin, $loginKey, $uuid, $REMOTE_ADDR = '125.88.168.100'){

    include_once SYSDIR_UTILS. "/REDIS.php";
    $redis_obj = new myRedis();
    $redis_obj->use_redis('login_key');
    $login_str = $redis_obj->redis->get( $loginKey );

    if( ! $login_str ){//登录态已失效
        //管理后台随机用户
        $simu_user = array(
            808528,808529,808530,808531,808532,808533,808534,808535,808536,808537,808538,808539,808540,808541,808542,808543,808544,808545,808546,808547,808548,808549,
            808550,808551,808552,808553,808554,808555,808556,808557,808558,808559,808560,808561,808562,808563,808564,808565,808566,808567,808568,808569,808570,808571,
            808572,808573,808574,808575,808576,808577,808578,808579,808580,808581,808582,808583,808584,808585,808586,808587,808588,808589,808590,808591,808592,808593,
            808594,808595,808596,808597,808598,808599,808600,808601,808602,808603,808604,808605,808606,808607,808608,808609,808610,808611,808612,808613,808614,808615,
            808616,808617,808618,808619,808620,808621,808622,808623,808624,808625,808626,808627,808628,808629,808630,808631,808632,808633,808634,808635,808636,808637,
            808638,808639,808640,808641,808642,808643,808644,808645,808646,808647,808648,808649,808650,808651,808652,808653,808654,808655,808656,808657,808658,808659,
            808660,808661,808662,808663,808664,808665,808666,808667,808668,808669,808670,808671,808672,808673,808674,808675,808676,808677,808678,808679,808680,808681,
            808682,808683,808684,808685,808686,808687,808688,808689,808690,808691,808692,808693,808694,808695,808696,808697,808698,808699,808700,808701,808702,808703,
            808704,808705,808706,808707,808708,808709,808710,808711,808712,808713,808714,808715,808716,808717,808718,808719,808720,808721,808722,808723,808724,808725,
            808726,808727,808728,808729,808730,808731,808732,808733,808734,808735,808736,808737,808738,808739,808740,808741,808742,808743,808744,808745,808746,808747,
            808748,808749,808750,808751,808752,808753,808754,808755,808756,808757,808758,808759,808760,808761,808762,808763,808764,808765,808766,808767,808768,808769,
            808770,808771,808772,808773,808774,808775,808776,808777,808778,808779,808780,808781,808782,808783,808784,808785,808786,808787,808788,808789,808790,808791,
            808792,808793,808794,808795,808796,808797,808798,808799,808800,808801,808802,808803,808804,808805,808806,808807,808808,808809,808810,808811,808812,808813,
            808814,808815,808816,808817,808818,808819,808820,808821,808822,808823,808824,808825,808826,808827,808828,808829,808830,808831,808832,808833,808834,808835,
            808836,808837,808838,808839,808840,808841,808842,808843,808844,808845,808846,808847,808848,808849,808850,808851,808852,808853,808854,808855,808856,808857,
            808858,808859,808860,808861,808862,808863,808864,808865,808866,808867,808868,808869,808870,808871,808872,808873,808874,808875,808876,808877,808878,808879,
            808880,808881,808882,808883,808884,808885,808886,808887,808888,808889,808890,808891,808892,808893,808894,808895,808896,808897,808898,808899,808900,808901,
            808902,808903,808904,808905,808906,808907,808908,808909,808910,808911,808912,808913,808914,808915,808916,808917,808918,808919,808920,808921,808922,808923,
            808924,808925,808926,808927,808928,808929,808930,808931,808932,808933,808934,808935,808936,808937,808938,808939,808940,808941,808942,808943,808944,808945,
            808946,808947,808948,808949,808950,808951,808952,808953,808954,808955,808956,808957,808958,808959,808960,808961,808962,808963,808964,808965,808966,808967,
            808968,808969,808970,808971,808972,808973,808974,808975,808976,808977,808978,808979,808980,808981,808982,808983,808984,808985,808986,808987,808988,808989,
            808990,808991,808992,808993,808994,808995,808996,808997,808998,808999,809000,809001,809002,809003,809004,809005,809006,809007,809008,809009,809010,809011,
            809012,809013,809014,809015,809016,809017,809018,809019,809020,809021,809022,809023,809024,809025,809026,809027,2684,787121,865245,677327,660462
        );
        if( ! in_array( $userUin, $simu_user ) && $REMOTE_ADDR!='125.88.168.10' ){
            return 1002;//登录态验证失败（需要登陆或者重新登陆）1002=XXUnityCS_Err_Not_Login是登陆态失效
        }
    }
    else{
        include_once dirname(dirname(__FILE__)) . "/apiprotocols/XXRedisUnityLogin.proto.php";
        $login_data = XXProto_XXRedisUnityLoginData::parseFromString($login_str);
        $loginKey_uin = $login_data->getUin();
        $loginKey_UserInfo = $login_data->getUser_info();
        $loginKey_createTime = $login_data->getCreateTime();
        if( $loginKey_uin!=$userUin || !is_object($loginKey_UserInfo) ||  $loginKey_UserInfo->getUuid()!==$uuid || abs(time()-$loginKey_createTime)>86400*30 ){// 7天 ?
            return 1001;//登录态验证失败（需要登陆或者重新登陆）1001=XXUnityCS_Err_Auth_Fail 是鉴权失效
        }
        else{
            $redis_obj->redis->setTimeout( $loginKey, 86400*30 );
        }
    }

    return true;
}


?>
